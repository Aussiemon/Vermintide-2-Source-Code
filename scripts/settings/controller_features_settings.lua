-- chunkname: @scripts/settings/controller_features_settings.lua

RumbleTemplates = {
	full_stop = {
		motors = {
			0,
			1,
		},
		params = {
			{
				attack = 0,
				attack_level = 0,
				decay = 0,
				frequency = 0,
				offset = 0,
				release = 0,
				sustain = 0,
				sustain_level = 0,
				period = math.huge,
			},
			{
				attack = 0,
				attack_level = 0,
				decay = 0,
				frequency = 0,
				offset = 0,
				release = 0,
				sustain = 0,
				sustain_level = 0,
				period = math.huge,
			},
		},
	},
	aim_start = {
		motors = {
			0,
			1,
		},
		params = {
			{
				attack = 0.2,
				attack_level = 0.01,
				decay = 0,
				frequency = 0,
				offset = 0,
				release = 0,
				sustain = 0.15,
				sustain_level = 0.15,
				period = math.huge,
			},
			{
				attack = 0.2,
				attack_level = 0.01,
				decay = 0,
				frequency = 0,
				offset = 0,
				release = 0,
				sustain = 0.15,
				sustain_level = 0.15,
				period = math.huge,
			},
		},
	},
	overcharge_rumble = {
		motors = {
			0,
			1,
		},
		params = {
			{
				attack = 0.3,
				attack_level = 0.15,
				decay = 0,
				frequency = 0,
				offset = 0,
				release = 0,
				sustain = 1.5,
				sustain_level = 0.1,
				period = math.huge,
			},
			{
				attack = 0.3,
				attack_level = 0.1,
				decay = 0,
				frequency = 0,
				offset = 0,
				release = 0,
				sustain = 1.3,
				sustain_level = 0.1,
				period = math.huge,
			},
		},
	},
	overcharge_rumble_overcharged = {
		motors = {
			0,
			1,
		},
		params = {
			{
				attack = 0.3,
				attack_level = 0.2,
				decay = 0,
				frequency = 0,
				offset = 0,
				release = 0,
				sustain = 1.5,
				sustain_level = 0.15,
				period = math.huge,
			},
			{
				attack = 0.3,
				attack_level = 0.25,
				decay = 0,
				frequency = 0,
				offset = 0,
				release = 0,
				sustain = 1.3,
				sustain_level = 0.15,
				period = math.huge,
			},
		},
	},
	overcharge_rumble_crit = {
		motors = {
			0,
			1,
		},
		params = {
			{
				attack = 0.3,
				attack_level = 0.3,
				decay = 0,
				frequency = 0,
				offset = 0,
				release = 0,
				sustain = 1.5,
				sustain_level = 0.2,
				period = math.huge,
			},
			{
				attack = 0.3,
				attack_level = 0.3,
				decay = 0,
				frequency = 0,
				offset = 0,
				release = 0,
				sustain = 1.5,
				sustain_level = 0.2,
				period = math.huge,
			},
		},
	},
	reload_start = {
		motors = {
			0,
			1,
		},
		params = {
			{
				attack = 0.3,
				attack_level = 0.2,
				decay = 0,
				frequency = 0,
				offset = 0,
				release = 0,
				sustain = 0.5,
				sustain_level = 0.1,
				period = math.huge,
			},
			{
				attack = 0.3,
				attack_level = 0.1,
				decay = 0,
				frequency = 0,
				offset = 0,
				release = 0,
				sustain = 0.3,
				sustain_level = 0.2,
				period = math.huge,
			},
		},
	},
	reload_over = {
		motors = {
			0,
			1,
		},
		params = {
			{
				attack = 0.2,
				attack_level = 0.3,
				decay = 0,
				frequency = 0,
				offset = 0,
				release = 0,
				sustain = 0,
				sustain_level = 0.5,
				period = math.huge,
			},
			{
				attack = 0.2,
				attack_level = 0.3,
				decay = 0,
				frequency = 0,
				offset = 0,
				release = 0,
				sustain = 0,
				sustain_level = 0.5,
				period = math.huge,
			},
		},
	},
	light_swing = {
		motors = {
			0,
			1,
		},
		params = {
			{
				attack = 0.3,
				attack_level = 0.2,
				decay = 0,
				frequency = 0,
				offset = 0,
				release = 0,
				sustain = 0.1,
				sustain_level = 0.1,
				period = math.huge,
			},
			{
				attack = 0.3,
				attack_level = 0.2,
				decay = 0,
				frequency = 0,
				offset = 0,
				release = 0,
				sustain = 0.1,
				sustain_level = 0.1,
				period = math.huge,
			},
		},
	},
	crossbow_fire = {
		motors = {
			0,
			1,
		},
		params = {
			{
				attack = 0.2,
				attack_level = 1,
				decay = 0,
				frequency = 0,
				offset = 0,
				release = 0,
				sustain = 0,
				sustain_level = 0.2,
				period = math.huge,
			},
			{
				attack = 0.2,
				attack_level = 1,
				decay = 0,
				frequency = 0,
				offset = 0,
				release = 0,
				sustain = 0,
				sustain_level = 0.2,
				period = math.huge,
			},
		},
	},
	bow_fire = {
		motors = {
			0,
			1,
		},
		params = {
			{
				attack = 0.2,
				attack_level = 0.35,
				decay = 0,
				frequency = 0,
				offset = 0,
				release = 0,
				sustain = 0,
				sustain_level = 0.2,
				period = math.huge,
			},
			{
				attack = 0.2,
				attack_level = 0.35,
				decay = 0,
				frequency = 0,
				offset = 0,
				release = 0,
				sustain = 0,
				sustain_level = 0.2,
				period = math.huge,
			},
		},
	},
	handgun_fire = {
		motors = {
			0,
			1,
		},
		params = {
			{
				attack = 0.2,
				attack_level = 1,
				decay = 0,
				frequency = 0,
				offset = 0,
				release = 0,
				sustain = 0.25,
				sustain_level = 0.5,
				period = math.huge,
			},
			{
				attack = 0.2,
				attack_level = 1,
				decay = 0,
				frequency = 0,
				offset = 0,
				release = 0,
				sustain = 0.25,
				sustain_level = 0.5,
				period = math.huge,
			},
		},
	},
	light_hit = {
		motors = {
			0,
		},
		params = {
			attack = 0,
			attack_level = 1,
			decay = 0,
			frequency = 0,
			offset = 0,
			release = 0,
			sustain = 0.3,
			sustain_level = 0.15,
			period = math.huge,
		},
	},
	medium_hit = {
		motors = {
			1,
		},
		params = {
			attack = 0,
			attack_level = 1,
			decay = 0,
			frequency = 0,
			offset = 0,
			release = 0,
			sustain = 0.3,
			sustain_level = 0.4,
			period = math.huge,
		},
	},
	heavy_hit = {
		motors = {
			0,
			1,
		},
		params = {
			attack = 0,
			attack_level = 1,
			decay = 0,
			frequency = 0,
			offset = 0,
			release = 0,
			sustain = 0.5,
			sustain_level = 0.7,
			period = math.huge,
		},
	},
	push_hit = {
		motors = {
			0,
			1,
		},
		params = {
			attack = 0,
			attack_level = 0.3,
			decay = 0,
			frequency = 0,
			offset = 0,
			release = 0,
			sustain = 0.3,
			sustain_level = 0.3,
			period = math.huge,
		},
	},
	block = {
		motors = {
			0,
			1,
		},
		params = {
			{
				attack = 0.2,
				attack_level = 0.65,
				decay = 0,
				frequency = 0,
				offset = 0,
				release = 0,
				sustain = 0.2,
				sustain_level = 0.5,
				period = math.huge,
			},
			{
				attack = 0.2,
				attack_level = 0.65,
				decay = 0,
				frequency = 0,
				offset = 0,
				release = 0,
				sustain = 0.1,
				sustain_level = 0.5,
				period = math.huge,
			},
		},
	},
	hit_environment = {
		motors = {
			0,
			1,
		},
		params = {
			{
				attack = 0.2,
				attack_level = 1,
				decay = 0,
				frequency = 0,
				offset = 0,
				release = 0,
				sustain = 0.2,
				sustain_level = 0.5,
				period = math.huge,
			},
			{
				attack = 0.2,
				attack_level = 1,
				decay = 0,
				frequency = 0,
				offset = 0,
				release = 0,
				sustain = 0.2,
				sustain_level = 0.5,
				period = math.huge,
			},
		},
	},
	hit_shield = {
		motors = {
			0,
			1,
		},
		params = {
			{
				attack = 0.2,
				attack_level = 1,
				decay = 0,
				frequency = 0,
				offset = 0,
				release = 0,
				sustain = 0.3,
				sustain_level = 0.5,
				period = math.huge,
			},
			{
				attack = 0.2,
				attack_level = 1,
				decay = 0,
				frequency = 0,
				offset = 0,
				release = 0,
				sustain = 0.3,
				sustain_level = 0.5,
				period = math.huge,
			},
		},
	},
	hit_character_light = {
		motors = {
			0,
			1,
		},
		params = {
			{
				attack = 0.2,
				attack_level = 0.5,
				decay = 0,
				frequency = 0,
				offset = 0,
				release = 0,
				sustain = 0,
				sustain_level = 0.35,
				period = math.huge,
			},
			{
				attack = 0.2,
				attack_level = 0.5,
				decay = 0,
				frequency = 0,
				offset = 0,
				release = 0,
				sustain = 0,
				sustain_level = 0.35,
				period = math.huge,
			},
		},
	},
	hit_character = {
		motors = {
			0,
			1,
		},
		params = {
			{
				attack = 0.2,
				attack_level = 1,
				decay = 0,
				frequency = 0,
				offset = 0,
				release = 0,
				sustain = 0,
				sustain_level = 0.75,
				period = math.huge,
			},
			{
				attack = 0.2,
				attack_level = 1,
				decay = 0,
				frequency = 0,
				offset = 0,
				release = 0,
				sustain = 0,
				sustain_level = 0.75,
				period = math.huge,
			},
		},
	},
	hit_armor = {
		motors = {
			0,
			1,
		},
		params = {
			{
				attack = 0.2,
				attack_level = 1,
				decay = 0,
				frequency = 0,
				offset = 0,
				release = 0,
				sustain = 0.3,
				sustain_level = 0.5,
				period = math.huge,
			},
			{
				attack = 0.2,
				attack_level = 1,
				decay = 0,
				frequency = 0,
				offset = 0,
				release = 0,
				sustain = 0.3,
				sustain_level = 0.5,
				period = math.huge,
			},
		},
	},
	camera_shake = {
		motors = {
			0,
			1,
		},
		params = {
			attack = 0,
			attack_level = 1,
			decay = 0,
			frequency = 0,
			offset = 0,
			release = 0,
			sustain = 0,
			sustain_level = 1,
			period = math.huge,
		},
		disabled_events = {
			castle_escape = true,
		},
	},
}

local CHECK_TIMER = 0.5

ControllerFeaturesSettings = {
	rumble = {
		init = function (self, params)
			local effect_data = RumbleTemplates[params.rumble_effect]

			if effect_data then
				self.ids = {}
				self._check_timer = CHECK_TIMER

				for _, motor_id in pairs(effect_data.motors) do
					self.ids[motor_id] = self.controller.rumble_effect(motor_id, effect_data.params[motor_id + 1] or effect_data.params)
				end
			else
				Application.warning(string.format("[ControllerFeaturesImplementation] No such rumble effect: %s", tostring(params.rumble_effect)))
			end
		end,
		update = function (self, dt, t)
			self._check_timer = self._check_timer - dt

			if self._check_timer <= 0 then
				self._check_timer = CHECK_TIMER

				for motor_id, rumble_id in pairs(self.ids) do
					if self.controller.is_rumble_effect_playing(motor_id, rumble_id) then
						return false
					end
				end

				return true
			else
				return false
			end
		end,
		destroy = function (self, dt, t)
			for motor_id, rumble_id in pairs(self.ids) do
				if self.controller.is_rumble_effect_playing(motor_id, rumble_id) then
					self.controller.stop_rumble_effect(motor_id, rumble_id)
				end
			end
		end,
	},
	hit_rumble = {
		init = function (self, params)
			local damage_amount = params.damage_amount
			local health = ScriptUnit.extension(params.unit, "health_system"):get_max_health()
			local difficulty_level = Managers.state.difficulty:get_difficulty_rank()
			local damage_percent = damage_amount / health
			local medium_limit = 0.025 * difficulty_level
			local heavy_limit = 0.06 * difficulty_level
			local effect_name = "light_hit"

			if medium_limit < damage_percent and damage_percent < heavy_limit then
				effect_name = "medium_hit"
			elseif heavy_limit <= damage_percent then
				effect_name = "heavy_hit"
			end

			local effect_data = RumbleTemplates[effect_name]

			if effect_data then
				self.ids = {}
				self._check_timer = CHECK_TIMER

				for _, motor_id in pairs(effect_data.motors) do
					self.ids[motor_id] = self.controller.rumble_effect(motor_id, effect_data.params)
				end
			else
				Application.warning(string.format("[ControllerFeaturesImplementation] No such rumble effect: %s", tostring(params.rumble_effect)))
			end
		end,
		update = function (self, dt, t)
			self._check_timer = self._check_timer - dt

			if self._check_timer <= 0 then
				self._check_timer = CHECK_TIMER

				for motor_id, rumble_id in pairs(self.ids) do
					if self.controller.is_rumble_effect_playing(motor_id, rumble_id) then
						return false
					end
				end

				return true
			else
				return false
			end
		end,
		destroy = function (self, dt, t)
			for motor_id, rumble_id in pairs(self.ids) do
				if self.controller.is_rumble_effect_playing(motor_id, rumble_id) then
					self.controller.stop_rumble_effect(motor_id, rumble_id)
				end
			end
		end,
	},
	camera_shake = {
		init = function (self, params)
			local shake_settings = params.shake_settings
			local effect_data = RumbleTemplates.camera_shake

			self.ids = {}
			self._check_timer = CHECK_TIMER

			if params.event_name and effect_data.disabled_events[params.event_name] then
				print("[CameraFeatureSettings] Trying to add disabled rumble event:", params.event_name)

				return
			end

			local attack = shake_settings.event.fade_in or 0
			local release = shake_settings.event.fade_out or 0
			local sustain = params.duration - attack
			local frequency = math.clamp(params.shake_settings.event.octaves or 0, 0, 6)
			local strength = 1 - 1 / (shake_settings.event.octaves or 1)
			local scale = strength * params.scale * shake_settings.event.amplitude * shake_settings.event.persistance * 0.5

			effect_data.params.attack = attack
			effect_data.params.attack_level = scale
			effect_data.params.frequency = frequency
			effect_data.params.release = release
			effect_data.params.sustain = sustain
			effect_data.params.sustain_level = scale

			for _, motor_id in pairs(effect_data.motors) do
				self.ids[motor_id] = self.controller.rumble_effect(motor_id, effect_data.params)
			end
		end,
		update = function (self, dt, t)
			self._check_timer = self._check_timer - dt

			if self._check_timer <= 0 then
				self._check_timer = CHECK_TIMER

				for motor_id, rumble_id in pairs(self.ids) do
					if self.controller.is_rumble_effect_playing(motor_id, rumble_id) then
						return false
					end
				end

				return true
			else
				return false
			end
		end,
		destroy = function (self, dt, t)
			for motor_id, rumble_id in pairs(self.ids) do
				if self.controller.is_rumble_effect_playing(motor_id, rumble_id) then
					self.controller.stop_rumble_effect(motor_id, rumble_id)
				end
			end
		end,
	},
	persistent_rumble = {
		init = function (self, params)
			local effect_data = table.clone(RumbleTemplates[params.rumble_effect])
			local sustain_function = params.sustain_function

			if effect_data then
				self.sustain_function = sustain_function
				self.ids = {}
				self.check_timer = CHECK_TIMER

				for _, motor in pairs(effect_data.params) do
					if motor.sustain then
						motor.sustain = math.huge
					end
				end

				for _, motor_id in pairs(effect_data.motors) do
					self.ids[motor_id] = self.controller.rumble_effect(motor_id, effect_data.params[motor_id + 1] or effect_data.params)
				end
			else
				Application.warning(string.format("[ControllerFeaturesImplementation] No such rumble effect: %s", tostring(params.rumble_effect)))
			end
		end,
		update = function (self, dt, t)
			self.check_timer = self.check_timer - dt

			if self.check_timer <= 0 then
				self.check_timer = CHECK_TIMER

				if self.sustain_function and not self.sustain_function() then
					return true
				end

				for motor_id, rumble_id in pairs(self.ids) do
					if self.controller.is_rumble_effect_playing(motor_id, rumble_id) then
						return false
					end
				end

				return true
			else
				return false
			end
		end,
		destroy = function (self, dt, t)
			for motor_id, rumble_id in pairs(self.ids) do
				if self.controller.is_rumble_effect_playing(motor_id, rumble_id) then
					self.controller.stop_rumble_effect(motor_id, rumble_id)
				end
			end
		end,
	},
}
